<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EcoRide ‚Äì Live-Karte</title>

  <!-- Supabase (global: window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --card:#111825; --text:#eaf0ff; --muted:#93a4bf; --line:#1f2a3d;
      --accent:#a855f7;
    }
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    #map{position:absolute; inset:0;}

    .panel{
      position:absolute; left:12px; top:12px; z-index:5;
      background:rgba(17,24,37,.92); backdrop-filter: blur(10px);
      border:1px solid var(--line); border-radius:14px; padding:12px; width:min(380px, calc(100vw - 24px));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .title{font-weight:800; letter-spacing:.2px; margin:0;}
    .muted{color:var(--muted); font-size:13px; margin:6px 0 0; line-height:1.35;}
    .row{display:flex; gap:8px; align-items:center; margin-top:10px;}
    input{
      flex:1; background:#0c1220; border:1px solid var(--line); color:var(--text);
      padding:10px 10px; border-radius:10px; outline:none;
    }
    button{
      background:var(--accent); border:0; color:white; font-weight:700;
      padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    button.secondary{background:#27324a;}
    
    .panel-icon{
  background: transparent;
  border: 0;
  font-size: 22px;
  cursor: pointer;
  color: var(--text);
  padding: 6px 8px;
  line-height: 1;
}

/* Icon bleibt sichtbar, auch wenn Panel eingeklappt ist */
.panel.collapsed .panel-icon{
  color: #fff;
}

/* Eingeklapptes Panel schmal */
.panel.collapsed{
  width: auto;
  padding: 6px;
}


.panel.collapsed .panel-icon{
  margin-left: 4px;
}

    .stat{margin-top:10px; font-size:13px; color:var(--muted); display:flex; justify-content:space-between; gap:10px;}
    .dot{display:inline-block; width:10px; height:10px; border-radius:50%; background:#ef4444; margin-right:6px;}
    .dot.on{background:#22c55e;}

    .marker{
      width:18px; height:18px; border-radius:50%;
      background:var(--accent);
      border:2px solid white;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }

    .hint{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      border:1px dashed var(--line);
      color:var(--muted);
      font-size:12px;
      display:none;
    }
    .hint.show{display:block;}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    
    /* ===== Popup kr√§ftig (wie CodePen) ===== */
.mapboxgl-popup-content{
  background: #ffffff !important;
  color: #0b0f14 !important;
  border-radius: 14px !important;
  padding: 12px 14px !important;
  box-shadow: 0 14px 30px rgba(0,0,0,.35) !important;
  font-size: 14px !important;
}
.mapboxgl-popup-close-button{
  color:#0b0f14 !important;
  font-size: 18px !important;
}
.mapboxgl-popup-tip{
  border-top-color:#ffffff !important;
}

/* EcoRide Popup Inhalt */
.er-popup{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; line-height:1.35;}
.er-tag{
  display:inline-block;
  font-size:11px;
  font-weight:800;
  letter-spacing:.06em;
  text-transform:uppercase;
  padding:3px 10px;
  border-radius:999px;
  background:#ffeaa7;
  color:#111;
  margin-bottom:8px;
}
.er-row{display:flex; gap:8px; align-items:center; margin-top:4px;}
.er-row b{font-weight:800;}
    
/* ===== Panel Toggle ===== */
.panel.collapsed .muted,
.panel.collapsed .row,
.panel.collapsed .stat,
.panel.collapsed .hint {
  display: none;
}

.panel.translucent {
  background: rgba(17,24,37,.55);
}

  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
<div class="panel-head">
  <p class="title">EcoRide ‚Äì Live-Karte</p>
  <button id="btnPanelMini" class="secondary mini-toggle">Einblenden</button>
</div>

    <p class="muted">
      Zeigt Live-Positionen aus <code>live_positions</code> (Supabase Realtime).
      Optional filterbar nach Driver ID.
    </p>

    <div class="row">
      <input id="driverFilter" placeholder="Filter: Driver ID (leer = alle)" />
      <button id="btnApply">Anwenden</button>
      <button id="btnAll" class="secondary">Alle</button>
    </div>
    
<div class="row toggle-row">
  <button id="btnPanelToggle" class="secondary">
    Ausblenden
  </button>
</div>

    <div class="stat">
      <div><span id="rtDot" class="dot"></span><span id="rtTxt">Realtime: AUS</span></div>
      <div><span id="countTxt">Marker: 0</span></div>
    </div>

    <div class="stat">
      <div>Letztes Update:</div>
      <div id="lastTxt">‚Äì</div>
    </div>

    <div id="hint" class="hint"></div>
  </div>

  <script>
    /***** 1) HIER EINTRAGEN *****/
    const MAPBOX_TOKEN = "pk.eyJ1IjoicGFwYXZlcm8iLCJhIjoiY21qZDJwZWxyMDJqbDNlczhuaGZseDdiciJ9.fO0N4kG-JevJi2dUGphOEQ";         // muss mit pk. beginnen
    const SUPABASE_URL = "https://ihpszsoivqcrkkiucjvv.supabase.co";         // https://xxxx.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlocHN6c29pdnFjcmtraXVjanZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjMyNDAsImV4cCI6MjA3NDAzOTI0MH0.RTqNvbND-SlW-ekKGsXEO5CY0ai8zgvQwRm_17WtUmw"; // publishable/anon key

    /***** 2) Helpers *****/
    const $ = (id) => document.getElementById(id);
    const rtDot = $("rtDot");
    const rtTxt = $("rtTxt");
    const countTxt = $("countTxt");
    const lastTxt = $("lastTxt");
    const driverFilter = $("driverFilter");
    const hintBox = $("hint");

    function showHint(msg){
      hintBox.textContent = msg;
      hintBox.classList.add("show");
    }
    function hideHint(){
      hintBox.classList.remove("show");
      hintBox.textContent = "";
    }
    function setRealtime(on){
      rtDot.classList.toggle("on", on);
      rtTxt.textContent = "Realtime: " + (on ? "AN" : "AUS");
    }
    function setLast(){
      lastTxt.textContent = new Date().toLocaleString("de-DE");
    }
    function setCount(n){
      countTxt.textContent = "Marker: " + n;
    }
    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
    function getFilterFromURL(){
      const u = new URL(location.href);
      return (u.searchParams.get("driverId") || "").trim();
    }
    function setURLFilter(f){
      const u = new URL(location.href);
      if (f) u.searchParams.set("driverId", f);
      else u.searchParams.delete("driverId");
      history.replaceState(null, "", u.toString());
    }

    /***** 3) Supabase Client (WICHTIG: Name "sb" statt "supabase") *****/
    if (!window.supabase || !window.supabase.createClient){
      showHint("Supabase SDK l√§dt nicht. Pr√ºfe Netzwerk/Adblocker.");
      console.error("Supabase SDK missing");
    }
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: false }
    });

    /***** 4) Map + Live State *****/
    let map;
    let channel = null;
    const markers = new Map(); // driver_id -> Marker
    let currentFilter = "";



// ===== Panel Toggle =====
const panel = document.querySelector(".panel");
const btnPanelToggle = document.getElementById("btnPanelToggle");

function updatePanelButton() {
  if (!panel || !btnPanelToggle) return;
  
 const collapsed = panel.classList.contains("collapsed");
btnPanelToggle.textContent = "‚èª";
btnPanelToggle.title = collapsed ? "Einblenden" : "Ausblenden";

}

if (btnPanelToggle && panel) {
  btnPanelToggle.addEventListener("click", () => {
    panel.classList.toggle("collapsed");
    updatePanelButton();
  });
}

updatePanelButton();


const TTL_MS = 20000;         // 20 Sekunden
const lastSeen = new Map();   // driver_id -> timestamp(ms)
    
    // ===== Marker Animation (weich statt springen) =====
const anim = new Map(); // driver_id -> { from:[lng,lat], to:[lng,lat], t0:number, dur:number }
const ANIM_MS = 700;    // Dauer der Bewegung (ms)


    function clearMarkers(){
      for (const m of markers.values()) m.remove();
      markers.clear();
      setCount(0);
    }

    function upsertMarker(row){
      if (!row || row.lat == null || row.lng == null) return;
      if (currentFilter && row.driver_id !== currentFilter) return;

      const driverId = row.driver_id || "unknown";
      const pos = [Number(row.lng), Number(row.lat)];

      let m = markers.get(driverId);
      if (!m){
        const el = document.createElement("div");
        el.className = "marker";

        m = new mapboxgl.Marker({ element: el })
          .setLngLat(pos)
.setPopup(new mapboxgl.Popup({ offset: 18 }).setHTML(`
  <div class="er-popup">
    <span class="er-tag">LIVE</span>
    <div class="er-row">üë§ Fahrer: <b>${escapeHtml(driverId)}</b></div>
    <div class="er-row">üìç Position: ${Number(row.lat).toFixed(5)}, ${Number(row.lng).toFixed(5)}</div>
    <div class="er-row">‚è±Ô∏è Letztes Update: ${
      row.updated_at
        ? new Date(row.updated_at).toLocaleTimeString("de-DE", {
            timeZone: "Europe/Berlin",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          })
        : "‚Äì"
    }</div>
  </div>
`))

          .addTo(map);

        markers.set(driverId, m);
        setCount(markers.size);
} else {
  const cur = m.getLngLat();
  anim.set(driverId, {
    from: [cur.lng, cur.lat],
    to: pos,
    t0: performance.now(),
    dur: ANIM_MS
  });
  requestAnimationFrame(tickAnim);
}

      const t = row.updated_at ? new Date(row.updated_at).getTime() : Date.now();
lastSeen.set(driverId, Number.isFinite(t) ? t : Date.now());

      setLast();
    }
function tickAnim() {
  const now = performance.now();
  let active = false;

  for (const [driverId, a] of anim.entries()) {
    const m = markers.get(driverId);
    if (!m) { anim.delete(driverId); continue; }

    const t = Math.min(1, (now - a.t0) / a.dur);
    const lng = a.from[0] + (a.to[0] - a.from[0]) * t;
    const lat = a.from[1] + (a.to[1] - a.from[1]) * t;

    m.setLngLat([lng, lat]);

    if (t >= 1) anim.delete(driverId);
    else active = true;
  }

  if (active) requestAnimationFrame(tickAnim);
}

function removeMarker(driverId){
  const m = markers.get(driverId);
  if (!m) return;
  m.remove();
  markers.delete(driverId);     // ‚úÖ WICHTIG
  lastSeen.delete(driverId);    // ‚úÖ WICHTIG
  setCount(markers.size);
  setLast();
}

setInterval(() => {
  const now = Date.now();
  for (const [driverId, ts] of lastSeen.entries()) {
    if ((now - ts) > TTL_MS) {
      removeMarker(driverId);   // ‚úÖ reicht
    }
  }
}, 3000);

  async function fetchLatest(){
      clearMarkers();

      let q = sb
        .from("live_positions")
        .select("driver_id, lat, lng, updated_at")
        .order("updated_at", { ascending: false })
        .limit(200);

      if (currentFilter) q = q.eq("driver_id", currentFilter);

      const { data, error } = await q;
      if (error){
        console.error("Supabase fetch error:", error);
        showHint("Supabase: Fehler beim Laden. (RLS/Policy?) Siehe Konsole.");
        return;
      }
      hideHint();

      // pro Driver nur den neuesten Datensatz
      const seen = new Set();
      for (const row of (data || [])){
        if (!row.driver_id) continue;
        if (seen.has(row.driver_id)) continue;
        seen.add(row.driver_id);
        upsertMarker(row);
      }

      // Auto-Zoom
      if (markers.size === 1){
        const only = [...markers.values()][0].getLngLat();
        map.flyTo({ center: [only.lng, only.lat], zoom: 14 });
      } else if (markers.size > 1){
        const bounds = new mapboxgl.LngLatBounds();
        for (const m of markers.values()){
          const p = m.getLngLat();
          bounds.extend([p.lng, p.lat]);
        }
        map.fitBounds(bounds, { padding: 80, maxZoom: 15 });
      }

      setLast();
    }

    function unsubscribe(){
      if (channel){
        sb.removeChannel(channel);
        channel = null;
      }
      setRealtime(false);
    }

    function subscribe(){
      unsubscribe();

      channel = sb
        .channel("live_positions_map")
        .on("postgres_changes", { event: "*", schema: "public", table: "live_positions" }, (payload) => {
          if (payload.eventType === "DELETE"){
            const oldRow = payload.old || {};
            if (oldRow.driver_id) removeMarker(oldRow.driver_id);
            return;
          }
          const row = payload.new || {};
          upsertMarker(row);
        })
        .subscribe((status) => {
          const on = (status === "SUBSCRIBED");
          setRealtime(on);
          if (!on) console.log("Realtime status:", status);
        });
    }

    function initMap(){
      // Mapbox Token setzen
      mapboxgl.accessToken = MAPBOX_TOKEN;

      map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [8.8, 53.1], // Bremen
        zoom: 10
      });

      map.addControl(new mapboxgl.NavigationControl(), "bottom-right");

      // Sichtbare Fehler, falls Mapbox blockt (Token/URL-Restriction/WebGL/Adblock)
      map.on("error", (e) => {
        console.error("Mapbox error:", e?.error || e);
        showHint("Mapbox l√§dt nicht. Pr√ºfe Token + URL-Restriction + Adblock. (Konsole √∂ffnen)");
      });

      map.on("load", async () => {
        hideHint();
        currentFilter = getFilterFromURL();
        driverFilter.value = currentFilter;

        await fetchLatest();
        subscribe();
      });
    }

    $("btnApply").addEventListener("click", async () => {
      currentFilter = driverFilter.value.trim();
      setURLFilter(currentFilter);
      await fetchLatest();
      // Realtime bleibt an; Updates werden gefiltert
    });

    $("btnAll").addEventListener("click", async () => {
      driverFilter.value = "";
      currentFilter = "";
      setURLFilter("");
      await fetchLatest();
    });

    // Start
    initMap();
  </script>
</body>
</html>

































